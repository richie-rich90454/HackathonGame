$(document).ready((function(){let e;$("#startModal").show(),$("#controls-toggle").hide();let t={width:window.innerWidth,height:window.innerHeight,skyGradient:["#000044","#88CCDD"],planeColor:"#FFF",planeSize:33.5,terrainSegmentWidth:10,terrainMaxDelta:40,terrainMinHeight:40,terrainMaxHeight:200,ballSpawnInterval:40,ballMinRadius:5,ballMaxRadius:20,cursorSize:30,cursorGlowRadius:8,cursorGradient:["#DE0000","#28465C"],reactionWindow:4e3,maxParticles:100,maxBalls:100,soundCooldown:100},a={player:{x:t.width/4,y:t.height/2,forwardSpeed:2.1,acceleration:.01,maxSpeed:12,verticalVelocity:0,verticalAcceleration:.25,maxVerticalSpeed:5,friction:.85,aura:null,auraTimestamp:0},terrain:[],balls:[],frame:0,keys:{},trailParticles:[],score:0,collectedElements:[],elements:[{name:"Feuer",color:"#DE0000"},{name:"Wasser",color:"#1C94E9"},{name:"Elektro",color:"#800089"},{name:"Rasen",color:"#009C17"},{name:"Kryo",color:"#59CFDA"},{name:"Gestein",color:"#FFAA44"},{name:"Luft",color:"#75C2AA"}],reactions:[{elements:["Feuer","Wasser"],name:"Vaporize",multiplier:2,type:"amplifying"},{elements:["Wasser","Feuer"],name:"Vaporize",multiplier:1.5,type:"amplifying"},{elements:["Feuer","Kryo"],name:"Melt",multiplier:2,type:"amplifying"},{elements:["Kryo","Feuer"],name:"Melt",multiplier:1.5,type:"amplifying"},{elements:["Elektro","Feuer"],name:"Overload",bonus:175,type:"transformative"},{elements:["Feuer","Elektro"],name:"Overload",bonus:175,type:"transformative"},{elements:["Elektro","Kryo"],name:"Superconduct",bonus:60,type:"transformative"},{elements:["Kryo","Elektro"],name:"Superconduct",bonus:60,type:"transformative"},{elements:["Elektro","Wasser"],name:"Elektro-Charge",bonus:90,type:"transformative"},{elements:["Wasser","Elektro"],name:"Elektro-Charge",bonus:90,type:"transformative"},{elements:["Luft","Feuer"],name:"Swirl",bonus:60,type:"transformative"},{elements:["Luft","Wasser"],name:"Swirl",bonus:60,type:"transformative"},{elements:["Luft","Elektro"],name:"Swirl",bonus:60,type:"transformative"},{elements:["Luft","Kryo"],name:"Swirl",bonus:60,type:"transformative"},{elements:["Gestein","Feuer"],name:"Crystallize",bonus:40,type:"transformative"},{elements:["Gestein","Wasser"],name:"Crystallize",bonus:40,type:"transformative"},{elements:["Gestein","Elektro"],name:"Crystallize",bonus:40,type:"transformative"},{elements:["Gestein","Kryo"],name:"Crystallize",bonus:40,type:"transformative"},{elements:["Feuer","Rasen"],name:"Burning",bonus:60,type:"transformative"},{elements:["Rasen","Feuer"],name:"Burning",bonus:60,type:"transformative"},{elements:["Wasser","Kryo"],name:"Frozen",bonus:40,type:"status"},{elements:["Kryo","Wasser"],name:"Frozen",bonus:40,type:"status"},{elements:["Wasser","Rasen"],name:"Bloom",bonus:70,type:"transformative"},{elements:["Rasen","Wasser"],name:"Bloom",bonus:70,type:"transformative"},{elements:["Rasen","Elektro"],name:"Quicken",bonus:60,type:"catalyze"},{elements:["Elektro","Rasen"],name:"Quicken",bonus:60,type:"catalyze"},{elements:["Elektro","Quicken"],name:"Aggravate",bonus:200,type:"catalyze"},{elements:["Rasen","Quicken"],name:"Spread",bonus:200,type:"catalyze"},{elements:["Feuer","Bloom"],name:"BurGesteinn",bonus:150,type:"transformative"},{elements:["Elektro","Bloom"],name:"Hyperbloom",bonus:150,type:"transformative"}],lastReactionMessage:{text:"",opacity:1,decay:.01},synth:null,lastSoundTime:0,startTime:null,maxSpeedUsed:8,reactionCounts:{},gameEnded:!1},r=document.getElementById("gameCanvas"),n=r.getContext("2d");if(!n)return void console.error("Canvas error, refresh to try again.");try{a.synth=new Tone.PolySynth(Tone.Synth).toDestination(),Tone.start()}catch(e){console.warn("Tone.js initialization failed:",e)}function l(){let e=document.querySelector("header").offsetHeight,n=document.querySelector("footer").offsetHeight;t.width=window.innerWidth,t.height=window.innerHeight-e-n,r.width=t.width,r.height=t.height,a.player.x=t.width/4,a.player.y=t.height/2,function(){a.terrain=[];let e=Math.ceil(t.width/t.terrainSegmentWidth)+2,r=(t.terrainMaxHeight+t.terrainMinHeight)/2;for(let n=0;n<e;n++)a.terrain.push({x:n*t.terrainSegmentWidth,y:t.height-r}),r+=(2*Math.random()-1)*t.terrainMaxDelta,r=Math.max(t.terrainMinHeight,Math.min(t.terrainMaxHeight,r))}(),a.balls.forEach((e=>{e.y=Math.min(e.y,t.height-e.r)}))}$("#startButton").click((function(){$("#startModal").hide(),$("#controls-toggle").show(),a.startTime=Date.now(),y()})),$("#restartButton").click((function(){window.location.reload()})),window.addEventListener("resize",l),l();let o={w:"up",s:"down","-":"slower","=":"faster","+":"faster",a:"slower",d:"faster"};function i(e){if(Date.now()-a.lastSoundTime<t.soundCooldown)return;if(!a.synth)return;let r;switch(e){case"Vaporize":r={oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("G4","8n",Tone.now(),.5);break;case"Melt":case"Spread":r={oscillator:{type:"triangle"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("A4","8n",Tone.now(),.5);break;case"Overload":case"BurGesteinn":r={oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.3,sustain:0,release:.3}},a.synth.set(r),a.synth.triggerAttackRelease("E3","4n",Tone.now(),.5);break;case"Superconduct":r={oscillator:{type:"square"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("F3","8n",Tone.now(),.5);break;case"Elektro-Charge":case"Hyperbloom":r={oscillator:{type:"pulse"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("D4","8n",Tone.now(),.5);break;case"Swirl":r={oscillator:{type:"sine"},envelope:{attack:.01,decay:.3,sustain:0,release:.3}},a.synth.set(r),a.synth.triggerAttackRelease("C5","4n",Tone.now(),.5);break;case"Crystallize":r={oscillator:{type:"triangle"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("B3","8n",Tone.now(),.5);break;case"Burning":r={oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.3,sustain:0,release:.3}},a.synth.set(r),a.synth.triggerAttackRelease("G3","4n",Tone.now(),.5);break;case"Frozen":r={oscillator:{type:"sine"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("A5","8n",Tone.now(),.5);break;case"Bloom":r={oscillator:{type:"triangle"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("E4","8n",Tone.now(),.5);break;case"Quicken":r={oscillator:{type:"pulse"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("F4","8n",Tone.now(),.5);break;case"Aggravate":r={oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.2,sustain:0,release:.2}},a.synth.set(r),a.synth.triggerAttackRelease("G4","8n",Tone.now(),.5)}a.lastSoundTime=Date.now()}function s(){if(a.gameEnded)return;var r;a.keys.faster&&(a.player.maxSpeed=Math.min(a.player.maxSpeed+.05,15),a.maxSpeedUsed=Math.max(a.maxSpeedUsed,a.player.maxSpeed)),a.keys.slower&&(a.player.maxSpeed=Math.max(a.player.maxSpeed-.05,1),a.maxSpeedUsed=Math.max(a.maxSpeedUsed,a.player.maxSpeed)),a.keys.up?a.player.verticalVelocity-=a.player.verticalAcceleration:a.keys.down?a.player.verticalVelocity+=a.player.verticalAcceleration:a.player.verticalVelocity*=a.player.friction,a.player.verticalVelocity=Math.max(-a.player.maxVerticalSpeed,Math.min(a.player.maxVerticalSpeed,a.player.verticalVelocity)),a.player.y=Math.max(20,Math.min(t.height-20,a.player.y+a.player.verticalVelocity)),a.player.forwardSpeed=Math.min(a.player.forwardSpeed+a.player.acceleration,a.player.maxSpeed),function(e){for(let t of a.terrain)t.x-=e;a.terrain=a.terrain.filter((e=>e.x>2*-t.terrainSegmentWidth));let r=a.terrain[a.terrain.length-1];for(;r.x<t.width+t.terrainSegmentWidth;){let e=t.height-r.y+(2*Math.random()-1)*t.terrainMaxDelta*.5;e=Math.max(t.terrainMinHeight,Math.min(t.terrainMaxHeight,e)),a.terrain.push({x:r.x+t.terrainSegmentWidth,y:t.height-e}),r=a.terrain[a.terrain.length-1]}}(a.player.forwardSpeed),r=a.player.forwardSpeed,a.balls.forEach((e=>e.x-=r)),a.balls=a.balls.filter((e=>{let r=a.player.x-e.x,n=a.player.y-e.y;if(Math.sqrt(r*r+n*n)<e.r+t.planeSize){Date.now()-a.lastSoundTime<t.soundCooldown||a.synth&&(a.synth.triggerAttackRelease("E4","8n",Tone.now(),1),a.lastSoundTime=Date.now());let r=Math.floor(10*e.r);return a.score+=r,e.collectTimestamp=Date.now(),function(e,r){let n=Date.now(),l=!1,o=!1;if(a.player.aura)for(let t of a.reactions){let[s,c]=t.elements;if(a.player.aura==s&&e==c||a.player.aura==c&&e==s){let e=0;"amplifying"==t.type?e=Math.floor(r*(t.multiplier-1)):"transformative"==t.type||"catalyze"==t.type?e=t.bonus:"status"==t.type&&(e=t.bonus,a.player.aura="Frozen",a.player.auraTimestamp=n,o=!1),a.score+=e,a.lastReactionMessage.text=`${t.name}!+${e}`,a.lastReactionMessage.opacity=1,a.reactionCounts[t.name]=(a.reactionCounts[t.name]||0)+1,i(t.name),l=!0,"status"!==t.type&&(o=!0);break}}if(!l){let r=a.collectedElements.concat({name:e,timestamp:n});for(let t of a.reactions){let[n,o]=t.elements;if(("Bloom"==o||"Quicken"==o)&&r.some((e=>e.name==o))&&e==n){let e=t.bonus;a.score+=e,a.lastReactionMessage.text=`${t.name}!+${e}`,a.lastReactionMessage.opacity=1,a.reactionCounts[t.name]=(a.reactionCounts[t.name]||0)+1,i(t.name);let n=r.findIndex((e=>e.name==o));n>=0&&r.splice(n,1),l=!0;break}}a.collectedElements=r.filter((e=>n-e.timestamp<t.reactionWindow))}l||a.player.aura&&!o?o&&(a.player.aura=null):(a.player.aura=e,a.player.auraTimestamp=n)}(e.element,r),!1}return e.x+e.r>0})),a.trailParticles.length<t.maxParticles&&a.trailParticles.push({x:a.player.x,y:a.player.y,size:.8*t.cursorSize,opacity:1,decay:.05}),a.trailParticles=a.trailParticles.filter((e=>e.opacity>0)),a.frame%t.ballSpawnInterval==0&&a.balls.length<t.maxBalls&&function(){let e=Math.random()*(t.ballMaxRadius-t.ballMinRadius)+t.ballMinRadius,r=a.elements[Math.floor(Math.random()*a.elements.length)];a.balls.push({x:t.width+e,y:Math.random()*(t.height-2*e)+e,r:1.2*e,color:r.color,element:r.name,collectTimestamp:0})}();let n=Date.now();a.collectedElements=a.collectedElements.filter((e=>n-e.timestamp<t.reactionWindow)),a.player.aura&&n-a.player.auraTimestamp>t.reactionWindow&&(a.player.aura=null),a.score>=1e4&&!a.gameEnded&&function(){a.gameEnded=!0,cancelAnimationFrame(e);let t=((Date.now()-a.startTime)/1e3).toFixed(1);$("#total-score").text(`Total Score: ${a.score}`),$("#time-taken").text(`Time Taken: ${t} seconds`);let r=$("#reaction-list");if(r.empty(),0==Object.keys(a.reactionCounts).length)r.append("<li>No reactions performed</li>");else for(let e in a.reactionCounts)r.append(`<li>${e}: ${a.reactionCounts[e]}</li>`);$("#endModal").show(),$("#controls-toggle").hide(),$("#touch-controls").hide()}(),a.frame++}function c(){n.clearRect(0,0,t.width,t.height),function(){let e=n.createLinearGradient(0,0,0,t.height);e.addColorStop(0,t.skyGradient[0]),e.addColorStop(1,t.skyGradient[1]),n.fillStyle=e,n.fillRect(0,0,t.width,t.height)}(),function(){n.fillStyle="#225535",n.beginPath(),n.moveTo(0,t.height);for(let e of a.terrain)n.lineTo(e.x,e.y);n.lineTo(t.width,t.height),n.closePath(),n.fill()}(),a.balls.forEach((e=>{n.beginPath(),n.arc(e.x,e.y,e.r,0,2*Math.PI),n.fillStyle=e.color,n.fill()})),function(){n.save(),n.translate(a.player.x,a.player.y);let e=Math.max(-Math.PI/6,Math.min(Math.PI/6,.1*a.player.verticalVelocity));n.rotate(e),n.fillStyle=t.planeColor,n.beginPath(),n.moveTo(t.planeSize,0),n.lineTo(-t.planeSize,-t.planeSize/2),n.lineTo(-t.planeSize,t.planeSize/2),n.closePath(),n.fill(),n.restore()}(),n.save(),a.trailParticles.forEach(((e,t)=>{n.globalAlpha=e.opacity,n.fillStyle=`rgba(255, 215, 0, ${e.opacity})`,n.beginPath();let a=Math.max(0,e.size*(1-.05*t));n.arc(e.x,e.y,a,0,2*Math.PI),n.fill(),e.opacity-=e.decay})),n.restore(),function(){n.save(),n.translate(a.player.x,a.player.y);let e=Math.atan2(a.player.verticalVelocity,a.player.forwardSpeed);n.rotate(e);let r=n.createRadialGradient(0,0,0,0,0,t.cursorSize+t.cursorGlowRadius);r.addColorStop(0,"#FFF"),r.addColorStop(1,t.cursorGradient[1]),n.fillStyle=r,n.beginPath(),n.arc(0,0,t.cursorSize+t.cursorGlowRadius,0,2*Math.PI),n.fill();let l=n.createRadialGradient(0,0,0,0,0,t.cursorSize);l.addColorStop(0,t.cursorGradient[0]),l.addColorStop(1,t.cursorGradient[1]),n.fillStyle=l,n.beginPath(),n.arc(0,0,t.cursorSize,0,2*Math.PI),n.fill(),n.strokeStyle="#000",n.lineWidth=2,n.beginPath(),n.moveTo(-t.cursorSize/2,0),n.lineTo(0,-t.cursorSize/2),n.lineTo(t.cursorSize/2,0),n.lineTo(0,t.cursorSize/2),n.closePath(),n.stroke(),n.restore()}(),function(){if(!a.player.aura)return;let e=Date.now(),r=t.reactionWindow-(e-a.player.auraTimestamp);if(r<=0)return;n.save(),n.translate(a.player.x+30,a.player.y-20),n.fillStyle="rgba(255, 255, 255, .7)",n.beginPath(),n.arc(0,0,10,0,2*Math.PI),n.fill(),n.fillStyle="#000",n.font='15px "EB Garamond"',n.textAlign="center",n.textBaseline="middle",n.fillText((r/1e3).toFixed(1),0,0),n.restore()}(),n.fillStyle="#FFF",n.font='16px "EB Garamond"',document.getElementById("cursor-speed").innerHTML=`Speed: ${a.player.forwardSpeed.toFixed(2)}`,document.getElementById("cursor-max-speed").innerHTML=`Max: ${a.player.maxSpeed.toFixed(2)}`,document.getElementById("cursor-score").innerHTML=`Score: ${a.score}`,a.lastReactionMessage.text&&(n.globalAlpha=a.lastReactionMessage.opacity,n.fillStyle="#FFD800",n.font='20px "EB Garamond"',n.fillText(a.lastReactionMessage.text,t.width/2-40,t.height/2),a.lastReactionMessage.opacity-=a.lastReactionMessage.decay,a.lastReactionMessage.opacity<=0&&(a.lastReactionMessage.text="",a.lastReactionMessage.opacity=1),n.globalAlpha=1)}function y(){s(),c(),e=requestAnimationFrame(y)}window.addEventListener("keydown",(e=>{let t=o[e.key.toLowerCase()];t&&(a.keys[t]=!0,e.preventDefault())})),window.addEventListener("keyup",(e=>{let t=o[e.key.toLowerCase()];t&&(a.keys[t]=!1,e.preventDefault())})),[["upBtn","up"],["downBtn","down"],["slowerBtn","slower"],["fasterBtn","faster"]].forEach((([e,t])=>{let r=document.getElementById(e);r&&(r.addEventListener("pointerdown",(e=>{e.preventDefault(),a.keys[t]=!0}),{passive:!1}),r.addEventListener("pointerup",(e=>{e.preventDefault(),a.keys[t]=!1}),{passive:!1}),r.addEventListener("pointerleave",(e=>{e.preventDefault(),a.keys[t]=!1}),{passive:!1}))})),r.addEventListener("touchmove",(e=>{let r=e.touches[0],n=document.querySelector("header").offsetHeight,l=r.clientY-n;a.keys.up=l<t.height/2,a.keys.down=l>t.height/2,e.preventDefault()}),{passive:!1}),r.addEventListener("touchend",(()=>{a.keys.up=a.keys.down=!1}));let m=$("#touch-controls"),p=$("#toggleControlsBtn");m.hide();let d=!1;p.text("Show Controls"),p.on("click",(function(){d=!d,m.slideToggle(200),p.text(d?"Hide Controls":"Show Controls")}))}));